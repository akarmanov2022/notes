---
tags:
  - Java
  - JavaConcurrency
links:
  - "[[Java Concurrency]]"
  - "[[Java]]"
---
Модель памяти Java. задана с точки зрения действий, которые включают
- чтение данных
- запись данных
- установку и снятие замков
- запуск и присоединение к потокам

# Happens-before

JVM определяет порядок (*happens-before*) для всех действий в программе.

*happens-before* гарантирует, что поток, выполняющий действие `B`, может видеть результаты действия `A` (независимо от того, происходят или нет A и B в разных потоках).

Правила для упорядочивания *happens-before*
- *Program order*. Каждое действие в потоке происходит перед каждым действием в нем: которе появляется позже в программном коде.
- *Правило мониторного замка*. Операция `unlock` на мониторном замке происходит перед каждой последующей операцией `lock` на этом же самом замке.
- *Правило переменной `volatile`*. Запись в волатильное поле происходит перед каждым последующим чтением из этого же поля.
- *Правило запуска потока*. Вызов `Thread.start` на потоки происходит перед каждым действием в запущенном потоке.
- *Правило терминации потока*. Любое действие в потоке происходит перед тем, как любой другой поток обнаружит, что поток терминироваля, успешно вернувшись из `Thread.join` либо вернув `false` с помощью `Thread.isActive`
- *Правило прерывания*. Ситуация, когда поток вызывает прерывание на другом потоке, происходит перед тем, как прерванный поток обнаружит прерывание.
- *Правило финализатора.* Завершение конструктора объекта происходит перед началом финализатора этого объекта.
- *Транзитивность.* Если `A` hb `B` и `B` hb `C`, то `A` hb `C` 

![[Pasted image 20240412223328.png]]

Упорядоченности *hp*, гарантированные библиотекой классов Java
- Размещение элемента в потокобезопасной коллекции происходит перед тем, как другой поток извлекает этот элемент из коллекции.
- Обратный отсчет на [[Строительные блоки#Защелки (latch)|защелке]] `CountDownLatch` происходит перед тем, как поток возвращает из `await` на этой защелке
- Освобождение разрешения назад [[Строительные блоки#Семафоры|семафору]] происходит перед получением разрешения от того же семафора
- Действия, предпринимаемые задаче, представленной `Future`, происходят перед тем, как другой поток успешно вернется из метода `Feature.get`
- Предоставление `Runnable` или `Callable` исполнителю `Executor` происходит перед началом выполнения задачи.