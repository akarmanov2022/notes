---
tags: 
links:
  - "[[Индексы и Ограничения в SQL]]"
---
## Для чего разработчику понимать нюансы работы БД?

Разработчику *нужно* выбирать из множества существующих БД, подходящую именно для вашего приложения.

****

# Базовые структуры БД

**Журнал** - структура данных БД, предназначенная только для добавления данных в конец.

**Индекс** - дополнительная структура БД. Могут без воздействия на данные удалятся и добавляться в БД. Влияют только на скорость зарпосов и скорость записи.

Важный компромисс в системах хранения данных: хорошо подобранные индексы ускоряют запросы на чтение, но замедляют запись.

## Хеш-индексы

Хранилища типа "ключ-значение" схожи с типом "*словарь*", реализованном в большинстве языков программирования.

Достоинства хеш-индесов
1. Позволяет хранить хеш каждого ключа, что ускоряет его поиск при запросе.
2. Хеши ключей сохраняются при перемещении ключа в журнале.

### Как избежать ситуации исчерпания места на диске?

Хорошим решением будет разбить журнал на сегменты определенного размера и закрывать к нему доступ при достижении этого размера.

Далее, необходимо выполнить *уплотнение* (compaction) этих сегментов.

> Уплотнение - процесс отбрасывания дублирующихся ключей из журнала и сохранения только последней версии данных для каждого ключа.

Пример процесса уплотнения
![[Pasted image 20240823161721.png]]
Т.к. уплотнения приводит к уменьшению (порой значительному) размера каждого сегмента, то имеет смысл провести процедуру *слияния* (merge) этих сегментов в один. Это решает проблему наличия дублирующихся ключей в разных сегментах журнала.
Сегменты никогда не меняются после записи, так что объединенный сегмент записывается в новый файл.

Слияние и уплотнение замороженных сегментов может происходить в фоновом процессе, что так же увеличит общую производительность хранилища, т.к. не будет мешать обслуживанию запросов на чтение и запись других сегментов.

Пример процесса уплотнения и слияния
![[Pasted image 20240823163055.png]]
Для воплощения этой простой идеи в жизнь, необходимо учесть ряд факторов
1. *Формат файлов*. Самый подходящий вариант - двоичный, т.к. не придется заботиться об экранировании данных.\
2. *Удаление записей.* Для удаления записи из журнала приходится добавлять специальную запись об удалении (tombstone). При процессе слияния сегментов записи с этой пометкой будут игнорироваться и отбрасываться.
3. *Восстановление после сбоев*. Решается сохранением снимка хеш-карты на диск и его последующей загрузкой при перезапуске журнала.
4. *Недописанные записи.*
5. Управление конкурентным доступом.

#### Почему вариант с журналами, допускающими запись только в конец, более удачен?
- Добавление в конец и слияние - последовательные операции слияния, которые в большинстве случаев выполняются быстро.
- Конкурентный доступ и восстановление после сбоев сильно упрощаются в случае допускающих только добавление или вообще неизменяемых данных.
- Слияние старых сегментов позволяет решить проблему фрагментирования данных с течением времени

## Ограничения хеш-индексов
1. Хеш-таблица должна помещаться в RAM. В связи с этим существует ограничение на количество ключей.
2. Запросы по диапазону неэффективны.

Следующие структуры данных снимают эти ограничения.

## SS-таблицы и LSM-деревья

Та же последовательность пар "ключ-значение", но **отсортированная** по ключу называется Sorted String Table (SS-Table).

Преимущества SS-таблиц перед журнальными сегментами с хеш-индексами.
1. Объединение сегментов выполняется просто и эффективно. Сам процесс напоминает алгоритм [[Сортировка слиянием|merge sort]].
   ![[Pasted image 20240827103045.png]]
2. Чтобы найти в файле конкретный ключ, не нужно больше хранить индексы всех ключей. Благодаря этому ключи могут быть более разряженными: одного ключа для каждых нескольких килобайт файла сегмента вполне достаточно.
3. Можно сгруппировать записи, необходимы для просмотра из заданного диапазона, и сжать в блок перед записью на диск. Это сэкономит пространство на диске.
   ![[Pasted image 20240827103703.png]]

Подобные индексная структура называются **LSM-Tree** (Long-Structured Merge-Tree). Системы на ее основе называются **LSM-подсистемами хранения**.