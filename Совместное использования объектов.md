---
tags:
  - JavaConcurrency
  - Java
links:
  - "[[Java Concurrency]]"
---
# Видимость

Без синхронизации компилятор, процессов и рабочая среда могут запутать порядок выполнения операций. Не стоит ожидать естественного порядка действий памяти в недостаточно синхронизированный многопоточных программах.

# Неатомарные 64-разрядные операции

Операции IO у 64-разрядных числовых переменных (`double` и `long`), разрешено воспринимать как две 32-разрядные операции. В связи с этим важно синхронизировать эти операции, например, с помощью `volatile`.

# Блокировка и видимость

Чтобы обеспечить видимость актуальных значений совместный волатильных переменных, необходимо синхронизировать читающие и пишущие потоки.
![[Pasted image 20240410171312.png]]
# Чувствительные (волатильные) переменные

Использование волатильных переменных - более слабая версия синхронизации.
Изменение состояния такой переменной распространится на все потоки.

Переменная `volatile` для компилятора и рабочей среды всегда совместна, то есть операции над ней не будут переупорядочены с другими операциями в памяти.
Так же эти переменные не кэшируются в регистрах или кэшах каждого процессора, поэтому их чтение доступно всегда.
***
Волатильные переменные следует использовать тогда и только тогда, когда они упрощают реализацию и проверку политики синхронизации.

 > Волатильные переменные гарантируют только видимость.
 > Блокировка гарантирует видимость и атомарность.

 Использование
 - записи в переменную не зависят от ее текущего значения, либо есть гарантия, что значения переменной обновляются только одним потоком.
 - переменная не участвует в инвариантах с другими переменными состояния
 - при обращении к переменной заранее не требуется блокировка

# Публикация и ускользание

*Публикация* объекта означает его доступность за пределами текущей области действия.
*Ускользнувший* объект - объект, который не вовремя публикуется.

Пример публикации объекта через статическое поле
```Java
public static Set<Secret> knownSecrets;

public void initialize() {
	knownSecrets = new HashSet<Secret>();
}
```


Типичный пример ускользания объекта
```Java
class UnsafeStates {
	private String[] states = new String[] {
		"AK", "AL" ...
	};

	public String[] getStates() { return states; }
}
```

>[!NOTE] Важно
>Нельзя позволять ссылке `this` ускользнуть во время конструирования.

# Ограничение одним потоком

Пример ограничения одним потоком через использование класса ThreadLocal
```Java
private static ThreadLocal<Connection> connectionHolder = new ThreadLocal<Connection>() {
	public Connection initialValue() {
		return DriverManager.getConnection(DB_URL);
	}
};

public static Connection getConnection() {
	return connectionHolder.get();
}
```

# Безопасная публикация
## Приемы безопасной публикации

Безопасную публикацию объекта, при который ссылка на него и его состояние видна всем потокам в одно и то же время, можно провести с помощью

- инициализации объектной ссылки из статического инициализатора
- сохранения ссылки на него в волатильном поле либо в `AtomicReference`
- сохранение ссылки на него в финальном поле
- сохранение ссылки в поле, которое защищено замком

## Мутируемые объекты

Требования публикации к мутируемым объектам
- немутируемые объекты могут быть опубликованы любым механизмом
- фактически немутируемые объекты должны быть безопасно опубликованы
- мутируемые объекты должны быть безопасно опубликованы и быть либо потокобезопасными, либо защищены замком.

## Безопасное совместное использование объектов

Наиболее полезные политик для применения и совместного использования объектов в конкурентной среде.

*Ограничение одним потоком*

*Совместный доступ только для чтения*
Потоки могут обращаться к объекту, предназначенному только для чтения, конкурентно, без дополнительной синхронизации и возможности его изменять. Совместные объекты только для чтения включают немутируемые и фактически немутируемые объекты. 

*Совместная потокобезопасность*
Потокобезопасный объект выполняет синхронизацию внутренне, поэтому потоки могут свободно обращаться к нему через его публичный интерфейс без дополнительной синхронизации.

*Защищенность*
С удержанием конкретного замка можно обращаться к объекту, инкасулированному в другие потокобезопасные объекты, а также к опубликованному объекту, защищенному замоком.
