---
tags:
  - JavaConcurrency
  - Java
  - Книга
links: "[[Java Concurrency]]"
---
Эта глава посвящена использованию конкурентных строительных блоков, таких как *коллекции* и *синхронизаторы*.

# Синхронизированные коллекции
К *синхронизированным классам коллекций* относятся `Vector` и `HashTable` и оберточные классы, создаваемые фабричными методами `Collections.synchronyzedXxx`.

## Проблемы синхронизации коллекций
Требуется блокировка на стороне клиента для защиты составных действий, таких как итеративный обход, навигация и условные операции.

>Составные действия над объектом `Vector`, которые могут привести к запутанным результатам

```Java
class Vector {
 //...
 public static Object getLast(Vector list) {
  int lastIndex = list.size() - 1;
  return list.get(lastSize);
 }
 public static void deleteLast(Vector list) {
  int lastIndex = list.size() - 1;
  list.remove(lastSize);
 }
}
```

Синхронизированные коллекции поддерживают блокировку на стороне клиента, поэтому существует возможность создания новых операций, атомарных по отношению к другим операциям над коллекцией, если известен замок.

>Составные действия над объектом `Vector`, с использование блокировки на стороне клиента

```Java
class Vector {
 //...
 public static Object getLast(Vector list) {
  synchronized (list) {
	int lastIndex = list.size() - 1;
	return list.get(lastSize);
  }
 }
 public static void deleteLast(Vector list) {
  synchronized (list) {
   int lastIndex = list.size() - 1;
   list.remove(lastSize);
  }
 }
}
```

## Итераторы и исключение CuncurrentModificationException

Итераторы синхронизированных коллекций не проектировались для конкурентного выполнения изменений, поэтому, обнаружив во время итеративного обхода изменения в коллекции, они выдают исключение CME.
Чтобы предотвратить исключению CME, надо владеть коллекционным замком в течение всего времени итеративного обхода.

Альтернативой запиранию коллекции во время итеративного обхода является ее клонирование и итеративный обход клона. Клон ограничен одним потоком, но коллекция все равно должна быть защищена замком во время клонирования. 

## Скрытые итераторы

